import{a as s}from"./chunk-M2BUHLXO.js";import{Jc as m,K as g,O as h,T as d,ec as n,j as f,ja as u,z as l}from"./chunk-6JS7X5LE.js";import{a,b as i}from"./chunk-I4MTPUBM.js";var p=class c{http=d(m);API_URL=`${s.url}system-config`;state=u({config:null,exchange_rate:null,isLoading:!1,error:null,logoPreloaded:!1});config=n(()=>this.state().config);exchangeRate=n(()=>this.state().exchange_rate);isLoading=n(()=>this.state().isLoading);error=n(()=>this.state().error);getConfig(){if(this.state().isLoading||this.state().config)return;if(localStorage.getItem("cookie_consent")==="true"){let e=localStorage.getItem("system_config_cache");if(e)try{let o=JSON.parse(e);this.state.set({config:o.config,exchange_rate:o.exchange_rate,isLoading:!1,error:null,logoPreloaded:!1}),this.preloadLogo(o.config),this.fetchFromApi(!0);return}catch(o){console.warn("Error al leer cach\xE9 de configuraci\xF3n",o),localStorage.removeItem("system_config_cache")}}this.fetchFromApi()}fetchFromApi(t=!1){t||this.state.update(e=>i(a({},e),{isLoading:!0,error:null})),this.http.get(`${this.API_URL}/get-public`).pipe(g(e=>{this.state.set({config:e.config,exchange_rate:e.exchange_rate,isLoading:!1,error:null,logoPreloaded:!1}),this.preloadLogo(e.config),localStorage.getItem("cookie_consent")==="true"&&localStorage.setItem("system_config_cache",JSON.stringify({config:e.config,exchange_rate:e.exchange_rate,timestamp:Date.now()}))}),l(e=>(t||this.state.update(o=>i(a({},o),{isLoading:!1,error:e.error?.message||"Error al cargar configuraci\xF3n"})),f(null)))).subscribe()}enableCache(){this.fetchFromApi(!0)}clearCache(){localStorage.removeItem("system_config_cache")}updateConfig(t){return this.http.put(`${this.API_URL}/update`,t).pipe(g(e=>{if(this.state.set(i(a({},this.state()),{config:e.config,isLoading:!1,error:null})),localStorage.getItem("cookie_consent")==="true"){let o=localStorage.getItem("system_config_cache"),r={config:e.config};if(o){let v=JSON.parse(o);r.exchange_rate=v.exchange_rate}r.timestamp=Date.now(),localStorage.setItem("system_config_cache",JSON.stringify(r))}}),l(e=>{throw e}))}buildLogoUrl(t){if(!t)return"https://via.placeholder.com/200x80?text=Logo";let e=t.trim();return`${s.url}system-config/logo/${e}`}buildFaviconUrl(t){if(!t)return"https://via.placeholder.com/32x32?text=Fav";let e=t.trim();return`${s.url}system-config/favicon/${e}`}resetState(){this.state.set({config:null,exchange_rate:null,isLoading:!1,error:null,logoPreloaded:!1})}preloadLogo(t){if(!t||this.state().logoPreloaded)return;let e=t.logo?this.buildLogoUrl(t.logo):null;if(!e)return;let o=new Image;o.onload=()=>{this.state.update(r=>i(a({},r),{logoPreloaded:!0}))},o.onerror=()=>{this.state.update(r=>i(a({},r),{logoPreloaded:!0}))},o.src=e}downloadBackup(){return this.http.get(`${this.API_URL}/backup/download`,{responseType:"blob",reportProgress:!0,observe:"events"})}restoreBackup(t){let e=new FormData;return e.append("file",t),this.http.post(`${this.API_URL}/backup/restore`,e,{reportProgress:!0,observe:"events"})}static \u0275fac=function(e){return new(e||c)};static \u0275prov=h({token:c,factory:c.\u0275fac,providedIn:"root"})};export{p as a};
