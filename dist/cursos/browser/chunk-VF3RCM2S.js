import{g as w}from"./chunk-VM3MHBTU.js";import{a as L}from"./chunk-TCGJFX72.js";import{a as o}from"./chunk-F4KIANN2.js";import{Jc as b,K as c,O as p,T as l,aa as y,ec as S,j as k,ja as g,ka as v,z as u}from"./chunk-6JS7X5LE.js";import{a as d}from"./chunk-I4MTPUBM.js";var m=class n{isDevelopment=!o.production;info(e,t){}warn(e,t){}error(e,t){}httpError(e,t,r){}debug(e,t){}operation(e,t,r){}signalState(e,t,r){}static \u0275fac=function(t){return new(t||n)};static \u0275prov=p({token:n,factory:n.\u0275fac,providedIn:"root"})};var T=class n{http=l(b);router=l(w);injector=l(y);logger=l(m);toast=l(L);logoutTimer=null;getFromStorage(e,t=!1){if(typeof window<"u"&&window.localStorage){let r=localStorage.getItem(e);if(!r)return null;try{return t?JSON.parse(r):r}catch{return null}}return null}user=g(this.getFromStorage("user",!0));token=g(this.getFromStorage("token"));isSessionLoaded=g(!1);isAuthenticating=g(!1);isLoggedIn=S(()=>!!this.user()&&!!this.token());sessionState=g({user:null,error:null,isLoading:!1,isLoaded:!1});currentUserAvatar=S(()=>{let e=this.user();return e?.avatar?`${o.images.user}${e.avatar}`:"https://i.pravatar.cc/128"});constructor(){this.checkTokenOnLoad(),v(()=>{let e=this.user(),t=this.token();typeof window<"u"&&window.localStorage&&(e&&t?(localStorage.setItem("user",JSON.stringify(e)),localStorage.setItem("token",t)):(localStorage.removeItem("user"),localStorage.removeItem("token")))}),v(()=>{let e=this.sessionState();this.isAuthenticating.set(e.isLoading),e.isLoaded&&(e.user?this.user.set(e.user):e.error&&(this.token.set(null),this.user.set(null)),this.isSessionLoaded.set(!0))}),setTimeout(()=>{this.verifyStoredSession()},0)}checkTokenOnLoad(){let e=this.token();if(e)try{let t=this.decodeTokenPayload(e);if(!t){this.forceLogout("Token inv\xE1lido");return}let r=Date.now(),s=t.exp*1e3;if(r>s)this.forceLogout("Tu sesi\xF3n ha expirado");else{let h=s-r;this.scheduleLogoutOnExpiration(h)}}catch{this.forceLogout("Error de autenticaci\xF3n")}}scheduleLogoutOnExpiration(e){this.logoutTimer&&clearTimeout(this.logoutTimer),this.logoutTimer=setTimeout(()=>{this.forceLogout("Tu sesi\xF3n ha expirado. Por favor inicia sesi\xF3n nuevamente.")},e)}decodeTokenPayload(e){try{let t=e.split(".");return t.length!==3?null:JSON.parse(atob(t[1]))}catch{return null}}forceLogout(e){this.logoutTimer&&(clearTimeout(this.logoutTimer),this.logoutTimer=null),this.token.set(null),this.user.set(null),import("./chunk-UIVGZW42.js").then(t=>{this.injector.get(t.PurchasesService).clearPurchases()}),this.toast.warning("Sesi\xF3n expirada",e),this.router.navigate(["/login"],{queryParams:{sessionExpired:"true"}})}verifyStoredSession(){let e=this.token(),t=this.user();e&&t?(this.isAuthenticating.set(!0),this.http.get(`${o.url}users/profile`).pipe(u(r=>((r.status===401||r.status===403)&&(this.token.set(null),this.user.set(null)),k(null)))).subscribe({next:r=>{if(r){if(r.profile){let s=r.profile;this.user.set(s)}else r.user&&this.user.set(r.user);import("./chunk-LRIZAU3L.js").then(s=>{this.injector.get(s.WalletService).loadWallet()})}},complete:()=>{this.isSessionLoaded.set(!0),this.isAuthenticating.set(!1)}})):this.isSessionLoaded.set(!0)}login(e,t){return this.isAuthenticating.set(!0),this.http.post(`${o.url}users/login`,{email:e,password:t}).pipe(c(r=>{let{token:s,user:i,profile:h}=r.USER,a=d(d({},i),h);this.token.set(s),this.user.set(a),this.toast.success(`\xA1Bienvenido ${a.name}!`,a.rol==="admin"?"Acceso como administrador":a.rol==="instructor"?"Acceso como instructor":"Has iniciado sesi\xF3n correctamente"),import("./chunk-UIVGZW42.js").then(f=>{this.injector.get(f.PurchasesService).loadPurchasedProducts()}),setTimeout(()=>{i.rol==="admin"||i.rol==="instructor"?this.router.navigate(["/dashboard"]):this.router.navigate(["/"])},100)}),u(r=>{throw this.isAuthenticating.set(!1),r}),c(()=>this.isAuthenticating.set(!1)))}logout(){this.token.set(null),this.user.set(null),import("./chunk-UIVGZW42.js").then(e=>{this.injector.get(e.PurchasesService).clearPurchases()}),this.toast.info("Sesi\xF3n cerrada","Has cerrado sesi\xF3n correctamente"),this.router.navigate(["/"])}updateUser(e){this.user.set(e)}register(e){return this.http.post(`${o.url}users/register`,e).pipe(c(()=>{this.toast.success("\xA1Registro exitoso!","Revisa tu correo para verificar tu cuenta")}),u(t=>{throw t}))}verifyOtp(e,t){return this.http.post(`${o.url}users/verify-otp`,{userId:e,code:t}).pipe(c(r=>{if(r.USER){let{token:s,user:i,profile:h}=r.USER,a=d(d({},i),h);this.token.set(s),this.user.set(a),this.toast.success("\xA1Cuenta verificada!",`Bienvenido ${a.name}, tu cuenta ha sido verificada`),import("./chunk-UIVGZW42.js").then(f=>{this.injector.get(f.PurchasesService).loadPurchasedProducts()}),setTimeout(()=>{i.rol==="admin"||i.rol==="instructor"?this.router.navigate(["/dashboard"]):this.router.navigate(["/"])},100)}}),u(r=>{throw this.toast.error("C\xF3digo inv\xE1lido","El c\xF3digo de verificaci\xF3n es incorrecto o ha expirado"),r}))}resendOtp(e){return this.http.post(`${o.url}users/resend-otp`,{userId:e}).pipe(c(()=>{this.toast.info("C\xF3digo enviado","Revisa tu correo electr\xF3nico")}),u(t=>{throw this.toast.error("Error al reenviar","No se pudo reenviar el c\xF3digo de verificaci\xF3n"),t}))}hasRole(e){return this.user()?.rol===e}hasAnyRole(e){let t=this.user()?.rol;return t?e.includes(t):!1}static \u0275fac=function(t){return new(t||n)};static \u0275prov=p({token:n,factory:n.\u0275fac,providedIn:"root"})};export{m as a,T as b};
