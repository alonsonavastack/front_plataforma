<header
  #headerElement
  class="sticky top-0 z-40 w-full backdrop-blur supports-[backdrop-filter]:bg-slate-950/80 bg-slate-950/70 border-b border-white/10">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
    <a routerLink="/" class="inline-flex items-center gap-2">
      <span class="h-9 w-9 rounded-xl bg-gradient-to-br from-lime-400 to-yellow-400 shadow-[0_0_20px_#a3e635] grid place-items-center text-slate-900 font-black">NC</span>
      <span class="font-semibold tracking-wide text-slate-200">NeoCourse</span>
    </a>

    <!-- Navegación para Escritorio -->
    <nav class="hidden lg:flex items-center gap-6 text-sm text-slate-300">
    </nav>

    <!-- Lado derecho: Carrito, Notificaciones, Perfil -->
    <div class="flex items-center gap-4">
      @if (!isOnAuthPage()) {
        <!-- Botón del Carrito -->
        <button (click)="cartService.toggleDrawer()" class="relative text-slate-400 hover:text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
          @if (cartService.totalItems() > 0) {
            <span class="absolute -top-2 -end-2 inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-red-500 border-2 border-slate-900 rounded-full">
              {{ cartService.totalItems() }}
            </span>
          }
        </button>
      }

      <!-- Botones de acción / Perfil de usuario (Escritorio) -->
      @if (!authService.isLoggedIn() && !isOnAuthPage()) {
        <div class="hidden lg:flex items-center gap-3">
        <a
          routerLink="/login"
          class="relative rounded-xl border border-lime-400/40 bg-gradient-to-b from-lime-400/20 to-emerald-400/10 text-slate-100
                 px-4 py-2 text-sm font-medium hover:shadow-[0_0_20px_#22c55e] hover:border-lime-400 transition ">
          Ingresar
        </a>
        <a routerLink="/register"
          class="rounded-xl border border-yellow-400/40 bg-gradient-to-b from-yellow-400/20 to-amber-400/10 text-slate-100
                 px-4 py-2 text-sm font-semibold hover:shadow-[0_0_20px_#facc15] hover:border-yellow-400 transition ">
          Crear cuenta
        </a>
        </div>
      } @else if (authService.isLoggedIn()) {
        <div class="hidden lg:block relative">
        <button (click)="toggleProfileMenu()" class="flex items-center gap-3">
          <span class="text-sm font-medium hidden sm:inline text-slate-200">Hola, {{ authService.user()?.name }}</span>
          <img class="w-9 h-9 rounded-full object-cover border-2 border-lime-400/50" [src]="authService.currentUserAvatar()" alt="Avatar">
        </button>
        @if (isProfileMenuOpen()) {
          <div class="absolute top-full right-0 mt-3 w-48 bg-slate-800/90 backdrop-blur rounded-md shadow-lg ring-1 ring-white/10 py-1 z-50"
               (clickOutside)="isProfileMenuOpen.set(false)">
            <a [routerLink]="getProfileLink()" (click)="isProfileMenuOpen.set(false)" class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700/80 hover:text-lime-300">Mi Panel</a>
            <a routerLink="/" (click)="isProfileMenuOpen.set(false)" class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700/80 hover:text-lime-300">Ver Sitio</a>
            @if (authService.user()?.rol === 'admin' || authService.user()?.rol === 'instructor') {
              <a routerLink="/dashboard" class="block py-2 pr-4 pl-3 rounded hover:bg-gray-700 text-lime-400 hover:text-white border-gray-700">Dashboard</a>
            }
            <div class="border-t border-white/10 my-1"></div>
            <button (click)="logout()" class="w-full text-left block px-4 py-2 text-sm text-red-400 font-medium hover:bg-slate-700/80">Cerrar Sesión</button>
          </div>
        }
        </div>
      }
      </div>

    @if (!isOnAuthPage()) {
      <!-- Botón de Menú (Móvil) -->
      <button
        type="button"
        class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-gray-500 rounded-lg lg:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600"
        data-drawer-target="drawer-navigation"
        data-drawer-show="drawer-navigation"
        aria-controls="drawer-navigation">
        <span class="sr-only">Abrir menú principal</span>
        <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 17 14">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1h15M1 7h15M1 13h15" />
        </svg>
      </button>
    }
  </div>
</header>

<!-- Menú Lateral (Drawer) -->
<div
  id="drawer-navigation"
  class="fixed top-0 left-0 z-50 h-screen p-4 overflow-y-auto transition-transform -translate-x-full bg-slate-900 w-80"
  tabindex="-1"
  aria-labelledby="drawer-navigation-label">
  <h5 id="drawer-navigation-label" class="text-base font-semibold text-gray-400 uppercase">Menú</h5>
  <button
    type="button"
    data-drawer-hide="drawer-navigation"
    aria-controls="drawer-navigation"
    class="text-gray-400 bg-transparent hover:bg-gray-700 hover:text-white rounded-lg text-sm w-8 h-8 absolute top-2.5 end-2.5 inline-flex items-center justify-center">
    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
      <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
    </svg>
    <span class="sr-only">Cerrar menú</span>
  </button>
  <div class="py-4 overflow-y-auto">
    <ul class="space-y-2 font-medium">
      <li>
        <a routerLink="/" class="flex items-center p-2 text-slate-200 rounded-lg hover:bg-gray-700 group">
          <span class="ms-3">Inicio</span>
        </a>
      </li>
      @if (authService.user()?.rol === 'admin' || authService.user()?.rol === 'instructor') {
        <li>
          <a routerLink="/dashboard" class="flex items-center p-2 text-slate-200 rounded-lg hover:bg-gray-700 group">
            <span class="ms-3">Dashboard</span>
          </a>
        </li>
      }
      <li>
        <a href="#" class="flex items-center p-2 text-slate-200 rounded-lg hover:bg-gray-700 group">
          <span class="ms-3">Blog</span>
        </a>
      </li>
      <li>
        <a href="#" class="flex items-center p-2 text-slate-200 rounded-lg hover:bg-gray-700 group">
          <span class="ms-3">Soporte</span>
        </a>
      </li>
    </ul>
    @if (!authService.isLoggedIn() && !isOnAuthPage()) {
      <div class="pt-4 mt-4 space-y-2 border-t border-gray-700">
        <a routerLink="/login" class="flex items-center p-2 text-slate-200 rounded-lg hover:bg-gray-700 group">Ingresar</a>
        <a routerLink="/register" class="flex items-center p-2 text-slate-200 rounded-lg hover:bg-gray-700 group">Crear cuenta</a>
      </div>
    } @else if (authService.isLoggedIn()) {
      <div class="pt-4 mt-4 space-y-2 border-t border-gray-700">
        <a [routerLink]="getProfileLink()" (click)="isProfileMenuOpen.set(false)" class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700/80 hover:text-lime-300">Mi Panel</a>
        <button (click)="logout()" class="w-full text-left block px-4 py-2 text-sm text-red-400 font-medium hover:bg-slate-700/80">Cerrar Sesión</button>
      </div>
    }
  </div>
</div>

<!-- === DRAWER DEL CARRITO DE COMPRAS === -->
@if (cartService.isDrawerOpen()) {
  <!-- Fondo (Backdrop) -->
  <div (click)="cartService.toggleDrawer()" class="bg-gray-900/50 fixed inset-0 z-40"></div>

  <!-- Contenido del Drawer -->
  <div class="fixed top-0 right-0 z-50 h-screen p-4 overflow-y-auto transition-transform transform-none bg-slate-800 w-96 shadow-2xl">
    <div class="flex flex-col h-full">
      <!-- Cabecera -->
      <div class="flex items-center justify-between mb-4">
        <h5 class="text-xl font-semibold text-white">Tu Carrito</h5>
        <button (click)="cartService.toggleDrawer()" type="button" class="text-gray-400 bg-transparent hover:bg-gray-700 hover:text-white rounded-lg text-sm p-1.5 inline-flex items-center">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
          <span class="sr-only">Cerrar carrito</span>
        </button>
      </div>

      <!-- Lista de artículos -->
      <div class="flex-grow overflow-y-auto -mr-4 pr-4">
        @if (cartService.totalItems() === 0) {
          <div class="flex flex-col items-center justify-center h-full text-center text-gray-400">
            <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            <p class="text-lg font-semibold">Tu carrito está vacío</p>
            <p class="text-sm">Añade cursos o proyectos para empezar.</p>
          </div>
        } @else {
          <ul class="space-y-3">
            @for (item of cartService.items(); track item._id) {
              <li class="flex items-start gap-4 p-2 rounded-lg bg-slate-700/50">
                <img [src]="buildImage(item.product.imagen)" alt="portada" class="w-24 h-16 object-cover rounded-md">
                <div class="flex-1">
                  <p class="text-sm font-medium text-white line-clamp-2">{{ item.product.title }}</p>
                  <p class="text-lg font-bold text-lime-300 mt-1">${{ item.total | number:'1.2-2' }}</p>
                </div>
                <button (click)="cartService.removeFromCart(item._id)" class="text-gray-500 hover:text-red-400 p-1">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                </button>
              </li>
            }
          </ul>
        }
      </div>

      <!-- Pie de página del carrito -->
      @if (cartService.totalItems() > 0) {
        <div class="border-t border-gray-700 pt-4 mt-4">
          <div class="flex justify-between text-lg font-semibold text-white">
            <span>Subtotal</span>
            <span>${{ cartService.subtotal() | number:'1.2-2' }}</span>
          </div>
          <p class="text-xs text-gray-400 mt-1">Los impuestos y gastos de envío se calculan en la pantalla de pago.</p>
          <button
            (click)="goToCheckout()"
            class="w-full mt-4 h-12 rounded-xl bg-lime-400 text-slate-900 font-bold hover:bg-lime-300 transition flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
            </svg>
            Proceder al Pago
          </button>
        </div>
      }
    </div>
  </div>
}
