<!-- src/app/shared/projects-card/projects-card.html -->
<div
  class="group relative h-full flex flex-col overflow-hidden rounded-2xl border border-white/10 bg-gradient-to-br from-slate-900/90 to-slate-800/90 backdrop-blur-sm transition-all duration-300 hover:border-lime-400/40 hover:shadow-xl hover:shadow-lime-500/10 hover:-translate-y-1">

  <!-- Badge de Ya Comprado -->
  @if (isPurchased()) {
  <div class="absolute top-3 left-3 z-20 px-3 py-1.5 rounded-xl text-xs font-bold
                bg-gradient-to-r from-emerald-500 to-teal-500 text-white shadow-lg
                flex items-center gap-1.5 backdrop-blur-sm">
    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd"
        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
        clip-rule="evenodd" />
    </svg>
    Comprado
  </div>
  }

  <!-- Imagen con efecto overlay -->
  <div class="relative overflow-hidden cursor-pointer" (click)="project().url_video ? onOpenVideo($event) : null">
    <!-- Overlay gradient -->
    <div
      class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/20 to-transparent opacity-60 z-10 group-hover:opacity-40 transition-opacity duration-300">
    </div>

    <!-- Imagen -->
    <div class="aspect-video overflow-hidden">
      <img [src]="imageUrl()" [alt]="project().title"
        class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
        [class.opacity-50]="isPurchased()" loading="lazy" decoding="async" />
    </div>

    <!-- Badge de descuento flotante -->
    @if (project().discount_active && !isPurchased()) {
    <div class="absolute top-3 right-3 z-20">
      <div class="relative">
        <!-- C铆rculo con animaci贸n de pulso -->
        <div class="absolute inset-0 rounded-full bg-lime-400 animate-ping opacity-75"></div>
        <div class="relative px-3 py-1.5 rounded-full text-xs font-black
                      bg-gradient-to-br from-lime-400 to-yellow-400 text-slate-900
                      shadow-lg flex items-center gap-1">
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd"
              d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z"
              clip-rule="evenodd" />
          </svg>
          -{{ project().discount_active?.discount }}{{ project().discount_active?.type_discount === 1 ? '%' :
          '' }}
        </div>
      </div>
    </div>
    }

    <!-- Icono de Play si hay video -->
    @if (project().url_video) {
    <div
      class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10">
      <div class="relative">
        <div class="absolute inset-0 bg-lime-400 rounded-full blur-xl opacity-50 animate-pulse"></div>
        <svg class="relative w-16 h-16 text-white drop-shadow-2xl" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd"
            d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
            clip-rule="evenodd"></path>
        </svg>
      </div>
    </div>
    }

    <!-- Categor铆a flotante en la parte inferior -->
    @if (project().categorie?.title) {
    <div class="absolute bottom-3 left-3 z-20">
      <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg
                     bg-slate-900/80 backdrop-blur-md border border-white/10
                     text-xs font-medium text-white/90">
        <svg class="w-3.5 h-3.5 text-lime-400" fill="currentColor" viewBox="0 0 20 20">
          <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path>
        </svg>
        {{ project().categorie?.title }}
      </span>
    </div>
    }
  </div>

  <!-- Contenido de la tarjeta -->
  <div class="flex-1 flex flex-col p-5 space-y-3">
    <!-- T铆tulo del proyecto -->
    <div class="block group/title">
      <h3 class="text-base font-bold text-white leading-tight line-clamp-2
                 group-hover/title:text-lime-300 transition-colors duration-200">
        {{ project().title }}
      </h3>
    </div>

    <!-- Instructor -->
    @if (instructor()) {
    <div class="flex items-center gap-2 text-xs text-white/60">
      <svg class="w-4 h-4 text-lime-400/60" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
      </svg>
      <span class="truncate">{{ instructor() }}</span>
    </div>
    }

    <!-- Subt铆tulo/Descripci贸n -->
    @if (project().subtitle) {
    <p class="text-sm text-white/60 line-clamp-2">
      {{ project().subtitle }}
    </p>
    }

    <!-- Spacer para empujar el precio y bot贸n hacia abajo -->
    <div class="flex-1"></div>

    <!-- L铆nea divisoria sutil -->
    <div class="h-px bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>

    <!-- Precio con dise帽o destacado -->
    <div class="flex items-center justify-between">
      @if (project()['isFree'] || project().price_mxn === 0) {
      <!-- Mostrar badge de GRATUITO si isFree es true O si el precio es 0 -->
      <span
        class="inline-flex items-center px-3 py-1.5 text-sm font-bold text-green-400 bg-green-500/10 border border-green-500/30 rounded-lg">
         GRATUITO
      </span>
      } @else {
      <!-- Mostrar precio normal -->
      <div class="flex items-baseline gap-2">
        @if (project().discount_active && project().final_price_mxn !== undefined) {
        <span class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-lime-400 to-emerald-400">
          {{ project().final_price_mxn | mxnCurrency:currencyService.selectedCurrencyCode() }} MXN
        </span>
        <span class="text-sm text-white/40 line-through font-medium">
          {{ project().price_mxn | mxnCurrency:currencyService.selectedCurrencyCode() }} MXN
        </span>
        } @else {
        <span class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-lime-400 to-emerald-400">
          {{ project().price_mxn | mxnCurrency:currencyService.selectedCurrencyCode() }} MXN
        </span>
        }
      </div>

      }
    </div>

    <!-- Bot贸n de acci贸n con estados -->
    <div class="pt-2">
      @if (isPurchased()) {
      <!-- Si ya fue comprado: Mostrar bot贸n de "Ver Proyecto" -->
      <div class="flex gap-2">
        <a [routerLink]="['/project-detail', project()._id]" (click)="$event.stopPropagation()" class="group/btn relative flex-1 text-center px-4 py-3 rounded-xl
                   bg-gradient-to-r from-emerald-500/20 to-teal-500/20
                   border border-emerald-500/40
                   text-emerald-400 font-bold text-sm
                   overflow-hidden
                   hover:from-emerald-500/30 hover:to-teal-500/30
                   hover:border-emerald-400/60
                   transition-all duration-300">
          <span class="relative z-10 flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path
                d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z">
              </path>
            </svg>
            Ver Proyecto
          </span>
          <!-- Shine effect -->
          <div class="absolute inset-0 -translate-x-full group-hover/btn:translate-x-full
                        bg-gradient-to-r from-transparent via-white/10 to-transparent
                        transition-transform duration-700 ease-out"></div>
        </a>

        <!-- Bot贸n de video si existe -->
        @if (project().url_video) {
        <button (click)="onOpenVideo($event)" class="group/btn relative px-4 py-3 rounded-xl font-bold text-sm
                     bg-gradient-to-r from-cyan-500/20 to-blue-500/20
                     border border-cyan-500/40
                     text-cyan-400
                     overflow-hidden
                     hover:from-cyan-500/30 hover:to-blue-500/30
                     hover:border-cyan-400/60
                     transition-all duration-300">
          <span class="relative z-10 flex items-center justify-center gap-1.5">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                clip-rule="evenodd"></path>
            </svg>
            <span class="hidden sm:inline">Video</span>
          </span>
          <!-- Shine effect -->
          <div class="absolute inset-0 -translate-x-full group-hover/btn:translate-x-full
                          bg-gradient-to-r from-transparent via-white/10 to-transparent
                          transition-transform duration-700 ease-out"></div>
        </button>
        }
        <!-- Bot贸n de Detalles (Ojo) -->
        <a [routerLink]="['/project-detail', project()._id]" (click)="$event.stopPropagation()" class="group/btn relative px-3 py-3 rounded-xl font-bold text-sm
         bg-white/5 border border-white/10 text-white/70
         hover:bg-white/10 hover:text-white hover:border-white/30
         transition-all duration-300 flex items-center justify-center" title="Ver descripci贸n">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
        </a>

        <!--  Bot贸n de Notas (solo en borrador para admin/propietario) -->
        @if (canManageNotes()) {
        <button (click)="openNotesModal($event)" class="group/btn relative px-3 py-3 rounded-xl font-bold text-sm
         bg-amber-500/20 border border-amber-500/40 text-amber-400
         hover:bg-amber-500/30 hover:border-amber-400/60
           transition-all duration-300 flex items-center justify-center" [title]="isAdmin() ? 'Agregar nota' : 'Ver notas'" [class.ring-1]="project().admin_notes">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
        </button>
        }
      </div>
      } @else {
      <!-- Si no fue comprado: Mostrar bot贸n de "Comprar" y opcionalmente video -->
      <div class="flex gap-2">
        <button (click)="buyNow($event)" class="group/btn relative flex-1 px-4 py-3 rounded-xl font-bold text-sm
                   bg-gradient-to-r from-lime-400 to-emerald-400
                   text-slate-900
                   overflow-hidden
                   hover:from-lime-300 hover:to-emerald-300
                   hover:shadow-lg hover:shadow-lime-500/30
                   active:scale-95
                   transition-all duration-200
                   flex items-center justify-center gap-2">
          <svg class="w-5 h-5 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
              d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          <div class="flex flex-col items-center leading-none">
            <span class="relative z-10 text-sm font-bold">Comprar</span>
          </div>
          <!-- Shine effect on hover -->
          <div class="absolute inset-0 -translate-x-full group-hover/btn:translate-x-full
                        bg-gradient-to-r from-transparent via-white/30 to-transparent
                        transition-transform duration-500 ease-out"></div>
        </button>

        <!-- Bot贸n de video preview si existe -->
        @if (project().url_video) {
        <button (click)="onOpenVideo($event)" class="group/btn relative px-4 py-3 rounded-xl font-bold text-sm
                     bg-gradient-to-r from-cyan-500/20 to-blue-500/20
                     border border-cyan-500/40
                     text-cyan-400
                     overflow-hidden
                     hover:from-cyan-500/30 hover:to-blue-500/30
                     hover:border-cyan-400/60
                     transition-all duration-300">
          <span class="relative z-10 flex items-center justify-center gap-1.5">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                clip-rule="evenodd"></path>
            </svg>
            <span class="hidden sm:inline">Vista previa</span>
          </span>
          <!-- Shine effect -->
          <div class="absolute inset-0 -translate-x-full group-hover/btn:translate-x-full
                          bg-gradient-to-r from-transparent via-white/10 to-transparent
                          transition-transform duration-700 ease-out"></div>
        </button>
        }
        <!-- Bot贸n de Detalles (Ojo) -->
        <a [routerLink]="['/project-detail', project()._id]" (click)="$event.stopPropagation()" class="group/btn relative px-3 py-3 rounded-xl font-bold text-sm
         bg-white/5 border border-white/10 text-white/70
         hover:bg-white/10 hover:text-white hover:border-white/30
         transition-all duration-300 flex items-center justify-center" title="Ver descripci贸n">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
        </a>
      </div>
      }
    </div>
  </div>

  <!-- Efecto de brillo en hover (borde superior) -->
  <div class="absolute inset-x-0 top-0 h-px bg-gradient-to-r from-transparent via-lime-400/0 to-transparent
              group-hover:via-lime-400/60 transition-all duration-300"></div>
</div>

<!--  MODAL DE NOTAS -->
@if (showNotesModal()) {
<!-- Backdrop -->
<div (click)="closeNotesModal()" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50"></div>

<!-- Modal -->
<div class="fixed inset-0 z-50 flex items-center justify-center p-4">
  <div (click)="$event.stopPropagation()" class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl shadow-2xl max-w-md w-full border border-white/10 overflow-hidden">
    <!-- Header -->
    <div class="bg-gradient-to-r from-amber-500/20 to-amber-600/20 px-6 py-4 border-b border-white/10 flex items-center justify-between">
      <h3 class="text-lg font-bold text-white flex items-center gap-2">
        <svg class="w-5 h-5 text-amber-400" fill="currentColor" viewBox="0 0 20 20">
          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
        </svg>
        {{ isAdmin() ? 'Nota de Administrador' : 'Notas del Proyecto' }}
      </h3>
      <button (click)="closeNotesModal()" class="text-white/60 hover:text-white transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Body -->
    <div class="px-6 py-4 space-y-4">
      <!-- Informaci贸n -->
      <div class="text-sm text-slate-300">
        <p class="mb-2">{{ isAdmin() ? 'Agregar una nota privada para este proyecto en estado borrador.' : 'Nota del administrador sobre este proyecto.' }}</p>
      </div>

      <!-- Textarea -->
      @if (isAdmin()) {
      <textarea
        [(ngModel)]="noteText"
        placeholder="Escribe tu nota aqu铆..."
        class="w-full h-32 px-4 py-3 bg-slate-900 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-amber-500/50 focus:border-amber-500/50 resize-none"
      ></textarea>
      } @else {
      <!-- Solo lectura para instructor -->
      <div class="w-full h-32 px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white/80 overflow-y-auto">
        {{ project().admin_notes || 'Sin notas' }}
      </div>
      }

      <!-- Informaci贸n de fecha -->
      @if (project().updatedAt) {
      <p class="text-xs text-slate-500">ltima actualizaci贸n: {{ project().updatedAt | date:'short' }}</p>
      }
    </div>

    <!-- Footer -->
    <div class="px-6 py-4 border-t border-white/10 flex gap-3">
      <button (click)="closeNotesModal()" class="flex-1 px-4 py-2 bg-slate-700/50 hover:bg-slate-700 text-slate-300 rounded-lg font-medium transition-colors">
        {{ isAdmin() ? 'Cancelar' : 'Cerrar' }}
      </button>
      @if (isAdmin()) {
      <button (click)="saveNote()" [disabled]="isSavingNote()" class="flex-1 px-4 py-2 bg-amber-500 hover:bg-amber-600 disabled:bg-amber-500/50 text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
        {{ isSavingNote() ? 'Guardando...' : 'Guardar Nota' }}
        @if (!isSavingNote()) {
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        }
      </button>
      }
    </div>
  </div>
</div>
}
