<header class="sticky top-0 z-20 w-full backdrop-blur supports-[backdrop-filter]:bg-slate-950/80 bg-slate-950/70 border-b border-white/10"
        (animate.enter)="animate.animateFadeInDashboard($event)">

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
    <!-- Branding + bot贸n que abre el drawer lateral -->
    <div class="flex items-center">
      <!-- Bot贸n que muestra el drawer de Flowbite (m贸vil) -->
      <button type="button"
              class="p-2.5 rounded-xl border border-white/10 hover:border-lime-400/50 hover:text-lime-300 transition lg:hidden"
              data-drawer-target="dashboard-drawer"
              data-drawer-show="dashboard-drawer"
              aria-controls="dashboard-drawer" aria-expanded="false">
        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-width="2" d="M4 6h16M4 12h12M4 18h8"/>
        </svg>
        <span class="sr-only">Abrir men煤 lateral</span>
      </button>

      <!-- Bot贸n para colapsar/expandir sidebar (solo desktop) -->
      <button (click)="toggleSidebar.emit()"
              class="hidden lg:flex items-center justify-center p-2.5 rounded-xl border border-transparent hover:border-lime-400/50 hover:text-lime-300 transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
        <span class="sr-only">Alternar men煤 lateral</span>
      </button>

      <!-- Logo (oculto en desktop cuando el sidebar est谩 expandido) -->
      <a routerLink="/" class="inline-flex items-center gap-2 ml-2" [class.lg:hidden]="!isSidebarCollapsed()">
        <!--  NUEVO: Logo din谩mico -->
        @if (systemConfigService.config()?.logo) {
          <img
            [src]="'http://localhost:3000/api/system-config/logo/' + systemConfigService.config()?.logo"
            [alt]="(systemConfigService.config()?.siteName || 'Dev-Sharks') + ' logo'"
            class="h-9 w-9 rounded-xl object-cover shadow-[0_0_20px_#a3e635]"
            (error)="$event.target.style.display='none'"
          />
        } @else {
          <span class="h-9 w-9 rounded-xl bg-gradient-to-br from-lime-400 to-yellow-400 shadow-[0_0_20px_#a3e635] grid place-items-center text-slate-900 font-black">
            {{ (systemConfigService.config()?.siteName || 'Dev-Sharks').charAt(0).toUpperCase() }}
          </span>
        }
        <!--  NUEVO: Nombre din谩mico -->
        <span class="font-semibold tracking-wide text-slate-200">
          {{ systemConfigService.config()?.siteName || 'Dev-Sharks' }}
        </span>
      </a>
    </div>

    <!-- Lado derecho: notificaciones + usuario + dropdown -->
    <div class="flex items-center gap-3">
      <!--  Campana de Notificaciones de Ventas (solo para admin) -->
      @if (authService.user()?.rol === 'admin') {
        <div class="relative">
          <button
            (click)="toggleNotificationsMenu()"
            class="relative p-2.5 rounded-xl border border-white/10 hover:border-lime-400/50 hover:text-lime-300 transition">
            <!-- Icono de campana -->
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
            </svg>

            <!-- Badge con el n煤mero de notificaciones -->
            @if (notificationsService.count() > 0) {
              <span class="absolute -top-1 -right-1 flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-white text-xs font-bold animate-pulse">
                {{ notificationsService.count() > 9 ? '9+' : notificationsService.count() }}
              </span>
            }
          </button>

          <!-- Dropdown de notificaciones -->
          @if (isNotificationsMenuOpen()) {
            <div
              class="fixed sm:absolute top-16 sm:top-full left-0 right-0 sm:left-auto sm:right-0 sm:mt-3 w-full sm:w-96 max-h-[calc(100vh-5rem)] sm:max-h-[32rem] overflow-y-auto bg-slate-800/95 backdrop-blur rounded-none sm:rounded-xl shadow-2xl ring-1 ring-white/10 z-50"
              (clickOutside)="isNotificationsMenuOpen.set(false)">

              <!-- Header -->
              <div class="sticky top-0 bg-slate-800 px-4 py-3 border-b border-white/10">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold text-white">Notificaciones</h3>
                  <div class="flex items-center gap-2">
                    <!-- Bot贸n de recarga manual -->
                    <button
                      (click)="reloadNotifications()"
                      class="p-1.5 rounded-md hover:bg-slate-700 text-slate-400 hover:text-lime-400 transition"
                      title="Recargar notificaciones">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                      </svg>
                    </button>
                    @if (notificationsService.sales().length > 0) {
                      <button
                        (click)="router.navigate(['/dashboard']); toggleNotificationsMenu();"
                        class="text-xs text-lime-400 hover:text-lime-300 font-medium">
                        Ver todas
                      </button>
                    }
                  </div>
                </div>
              </div>

              <!-- Lista de notificaciones -->
              <div class="py-2">
                @if (notificationsService.sales().length === 0) {
                  <div class="px-4 py-8 text-center">
                    <svg class="w-12 h-12 text-slate-600 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                    </svg>
                    <p class="text-sm text-slate-400">No hay nuevas notificaciones</p>
                  </div>
                } @else {
                  @for (sale of notificationsService.sales(); track sale._id) {
                    <div
                      (click)="goToSalesWithStatus(sale.status, sale._id)"
                      class="px-4 py-3 hover:bg-slate-700/50 transition-colors cursor-pointer border-b border-slate-700/50 last:border-0">
                      <div class="flex items-start gap-3">
                        <!-- Icono -->
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-lime-400/10 flex items-center justify-center">
                          <svg class="w-5 h-5 text-lime-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                          </svg>
                        </div>

                        <!-- Contenido -->
                        <div class="flex-1 min-w-0">
                          <p class="text-sm font-medium text-white">
                            Nueva compra de <span class="text-lime-400">{{ sale.user.name }} {{ sale.user.surname }}</span>
                          </p>
                          <p class="text-xs text-slate-400 mt-1">
                            Total: <span class="font-semibold text-lime-300">{{ sale.total | currency:sale.currency_total:'symbol':'1.2-2' }}</span>
                          </p>
                          <p class="text-xs text-slate-500 mt-1">
                            {{ sale.createdAt | date:'dd/MM/yyyy HH:mm' }}
                          </p>
                        </div>

                        <!-- Estado -->
                        <div class="flex-shrink-0">
                          <span [ngClass]="{
                            'bg-green-500/10 text-green-400 border-green-500/30': sale.status === 'Pagado',
                            'bg-yellow-500/10 text-yellow-400 border-yellow-500/30': sale.status === 'Pendiente'
                          }" class="inline-block px-2 py-1 text-xs font-semibold rounded-full border">
                            {{ sale.status }}
                          </span>
                        </div>
                      </div>
                    </div>
                  }
                }
              </div>
            </div>
          }
        </div>
      }

      <!--  Campana de Notificaciones Bancarias (solo para admin) -->
      @if (authService.user()?.rol === 'admin') {
        <div class="relative">
          <button
            (click)="toggleBankNotificationsMenu()"
            class="relative p-2.5 rounded-xl border border-white/10 hover:border-blue-400/50 hover:text-blue-300 transition">
            <!-- Icono de banco -->
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path>
            </svg>

            <!-- Badge con el n煤mero de notificaciones bancarias -->
            @if (bankNotificationsService.count() > 0) {
              <span class="absolute -top-1 -right-1 flex h-5 w-5 items-center justify-center rounded-full bg-blue-500 text-white text-xs font-bold animate-pulse">
                {{ bankNotificationsService.count() > 9 ? '9+' : bankNotificationsService.count() }}
              </span>
            }
          </button>

          <!-- Dropdown de notificaciones bancarias -->
          @if (isBankNotificationsMenuOpen()) {
            <div
              class="fixed sm:absolute top-16 sm:top-full left-0 right-0 sm:left-auto sm:right-0 sm:mt-3 w-full sm:w-96 max-h-[calc(100vh-5rem)] sm:max-h-[32rem] overflow-y-auto bg-slate-800/95 backdrop-blur rounded-none sm:rounded-xl shadow-2xl ring-1 ring-white/10 z-50"
              (clickOutside)="isBankNotificationsMenuOpen.set(false)">

              <!-- Header -->
              <div class="sticky top-0 bg-slate-800 px-4 py-3 border-b border-white/10">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold text-white"> Cuentas Bancarias Pendientes</h3>
                  <div class="flex items-center gap-2">
                    <!-- Bot贸n de recarga manual -->
                    <button
                      (click)="bankNotificationsService.reload()"
                      class="p-1.5 rounded-md hover:bg-slate-700 text-slate-400 hover:text-blue-400 transition"
                      title="Recargar notificaciones">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                      </svg>
                    </button>
                    @if (bankNotificationsService.count() > 0) {
                      <button
                        (click)="router.navigate(['/dashboard'], { queryParams: { section: 'admin-bank-verification' } }); isBankNotificationsMenuOpen.set(false);"
                        class="text-xs text-blue-400 hover:text-blue-300 font-medium">
                        Ver todas
                      </button>
                    }
                  </div>
                </div>
              </div>

              <!-- Lista de notificaciones bancarias -->
              <div class="py-2">
                @if (bankNotificationsService.count() === 0) {
                  <div class="px-4 py-8 text-center">
                    <svg class="w-12 h-12 text-slate-600 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-sm text-slate-400">No hay cuentas pendientes de verificaci贸n</p>
                  </div>
                } @else {
                  @for (notification of bankNotificationsService.pendingVerifications(); track notification._id) {
                    <div
                      (click)="router.navigate(['/dashboard'], { queryParams: { section: 'admin-bank-verification', instructorId: notification.instructor._id } }); isBankNotificationsMenuOpen.set(false);"
                      class="px-4 py-3 hover:bg-slate-700/50 transition-colors cursor-pointer border-b border-slate-700/50 last:border-0">
                      <div class="flex items-start gap-3">
                        <!-- Avatar del instructor -->
                        <div class="flex-shrink-0">
                          <img
                            [src]="notification.instructor.avatar || 'https://ui-avatars.com/api/?name=' + notification.instructor.name + '+' + notification.instructor.surname"
                            alt="Avatar"
                            class="w-10 h-10 rounded-full object-cover border-2 border-blue-400/30">
                        </div>

                        <!-- Contenido -->
                        <div class="flex-1 min-w-0">
                          <p class="text-sm font-medium text-white">
                            <span class="text-blue-400">{{ notification.instructor.name }} {{ notification.instructor.surname }}</span>
                            {{ notification.isRecentEdit ? 'actualiz贸' : 'agreg贸' }} su cuenta bancaria
                            @if (notification.isRecentEdit) {
                              <span class="ml-1 inline-flex items-center px-1.5 py-0.5 rounded text-xs font-semibold bg-orange-500/20 text-orange-400 border border-orange-500/30">
                                EDITADO
                              </span>
                            }
                          </p>
                          <p class="text-xs text-slate-400 mt-1">
                            Banco: <span class="font-semibold text-blue-300">{{ notification.bankDetails.bank_name }}</span>
                          </p>
                          <p class="text-xs text-slate-500 mt-1">
                            {{ notification.updatedAt | date:'dd/MM/yyyy HH:mm' }}
                          </p>
                        </div>

                        <!-- Estado -->
                        <div class="flex-shrink-0">
                          <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full border bg-yellow-500/10 text-yellow-400 border-yellow-500/30">
                            Pendiente
                          </span>
                        </div>
                      </div>
                    </div>
                  }
                }
              </div>
            </div>
          }
        </div>
      }

      <!--  Campana de Notificaciones de Reviews (solo para instructores) -->
      @if (authService.user()?.rol === 'instructor') {
        <div class="relative">
          <button
            (click)="toggleReviewNotificationsMenu()"
            class="relative p-2.5 rounded-xl border border-white/10 hover:border-purple-400/50 hover:text-purple-300 transition">
            <!-- Icono de mensajes/comentarios -->
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
            </svg>

            <!-- Badge con el n煤mero de notificaciones de reviews -->
            @if (reviewNotificationsService.count() > 0) {
              <span class="absolute -top-1 -right-1 flex h-5 w-5 items-center justify-center rounded-full bg-purple-500 text-white text-xs font-bold animate-pulse">
                {{ reviewNotificationsService.count() > 9 ? '9+' : reviewNotificationsService.count() }}
              </span>
            }
          </button>

          <!-- Dropdown de notificaciones de reviews -->
          @if (isReviewNotificationsMenuOpen()) {
            <div
              class="fixed sm:absolute top-16 sm:top-full left-0 right-0 sm:left-auto sm:right-0 sm:mt-3 w-full sm:w-96 max-h-[calc(100vh-5rem)] sm:max-h-[32rem] overflow-y-auto bg-slate-800/95 backdrop-blur rounded-none sm:rounded-xl shadow-2xl ring-1 ring-white/10 z-50"
              (clickOutside)="isReviewNotificationsMenuOpen.set(false)">

              <!-- Header -->
              <div class="sticky top-0 bg-slate-800 px-4 py-3 border-b border-white/10">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold text-white"> Reviews Sin Responder</h3>
                  <div class="flex items-center gap-2">
                    <!-- Bot贸n de recarga manual -->
                    <button
                      (click)="reviewNotificationsService.reload()"
                      class="p-1.5 rounded-md hover:bg-slate-700 text-slate-400 hover:text-purple-400 transition"
                      title="Recargar notificaciones">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                      </svg>
                    </button>
                    <!--  NUEVO: Bot贸n Marcar Todo Como Le铆do -->
                    @if (reviewNotificationsService.count() > 0) {
                      <button
                        (click)="markAllReviewsAsRead()"
                        class="text-xs text-purple-400 hover:text-purple-300 font-medium px-2 py-1 rounded-md hover:bg-purple-500/10 transition"
                        title="Marcar todas como le铆das">
                        Marcar todo le铆do
                      </button>
                    }
                  </div>
                </div>
              </div>

              <!-- Lista de notificaciones de reviews -->
              <div class="py-2">
                @if (reviewNotificationsService.count() === 0) {
                  <div class="px-4 py-8 text-center">
                    <svg class="w-12 h-12 text-slate-600 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-sm text-slate-400">No hay reviews pendientes de responder</p>
                  </div>
                } @else {
                  @for (notification of reviewNotificationsService.pendingReviews(); track notification._id) {
                    <div
                      (click)="router.navigate(['/course-detail', notification.course.slug], { fragment: 'reviews' }); isReviewNotificationsMenuOpen.set(false);"
                      class="px-4 py-3 hover:bg-slate-700/50 transition-colors cursor-pointer border-b border-slate-700/50 last:border-0">
                      <div class="flex items-start gap-3">
                        <!-- Avatar del estudiante -->
                        <div class="flex-shrink-0">
                          <img
                            [src]="notification.student.avatar || 'https://ui-avatars.com/api/?name=' + notification.student.name + '+' + notification.student.surname"
                            alt="Avatar"
                            class="w-10 h-10 rounded-full object-cover border-2 border-purple-400/30">
                        </div>

                        <!-- Contenido -->
                        <div class="flex-1 min-w-0">
                          <p class="text-sm font-medium text-white">
                            <span class="text-purple-400">{{ notification.student.full_name }}</span> coment贸 en tu curso
                            @if (notification.isRecent) {
                              <span class="ml-1 inline-flex items-center px-1.5 py-0.5 rounded text-xs font-semibold bg-green-500/20 text-green-400 border border-green-500/30">
                                NUEVO
                              </span>
                            }
                          </p>
                          <p class="text-xs text-slate-400 mt-1 truncate">
                            Curso: <span class="font-semibold text-purple-300">{{ notification.course.title }}</span>
                          </p>
                          <!-- Estrellas -->
                          <div class="flex items-center gap-1 mt-1">
                            @for (star of [1,2,3,4,5]; track star) {
                              <svg class="w-3 h-3" [class.text-yellow-400]="star <= notification.rating" [class.text-slate-600]="star > notification.rating" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                              </svg>
                            }
                            <span class="text-xs text-slate-500 ml-1">({{ notification.rating }})</span>
                          </div>
                          <p class="text-xs text-slate-500 mt-1">
                            {{ notification.createdAt | date:'dd/MM/yyyy HH:mm' }}
                          </p>
                        </div>

                        <!-- Indicador de acci贸n -->
                        <div class="flex-shrink-0">
                          <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                          </svg>
                        </div>
                      </div>
                    </div>
                  }
                }
              </div>
            </div>
          }
        </div>
      }

      <!-- Men煤 de usuario -->
      <div class="relative">
        <button (click)="toggleProfileMenu()" class="flex items-center gap-3">
          <span class="text-sm font-medium hidden sm:inline text-slate-200">Hola, {{ authService.user()?.name }}</span>
          <img class="w-9 h-9 rounded-full object-cover border-2 border-lime-400/50" [src]="authService.currentUserAvatar()" alt="Avatar">
        </button>
        @if (isProfileMenuOpen()) {
          <div class="fixed sm:absolute top-16 sm:top-full right-0 sm:mt-3 w-full sm:w-64 bg-slate-800/95 backdrop-blur rounded-none sm:rounded-md shadow-lg ring-1 ring-white/10 py-1 z-50"
               (clickOutside)="isProfileMenuOpen.set(false)">
            <div class="px-4 py-3 border-b border-white/10">
              <span class="block text-sm text-white">{{ authService.user()?.name }} {{ authService.user()?.surname }}</span>
              <span class="block text-xs text-white/60 truncate">{{ authService.user()?.email }}</span>
            </div>
            <a [routerLink]="getProfileLink()" (click)="toggleProfileMenu()" class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700/80 hover:text-lime-300">Mi Panel</a>
            <a routerLink="/" (click)="toggleProfileMenu()" class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700/80 hover:text-lime-300">Ver Sitio</a>

            <div class="border-t border-white/10 my-1"></div>
            <button (click)="logout()" class="w-full text-left block px-4 py-2 text-sm text-red-400 font-medium hover:bg-slate-700/80">Cerrar Sesi贸n</button>
          </div>
        }
      </div>
    </div>
  </div>
</header>
