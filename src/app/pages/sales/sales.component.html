<div class="bg-slate-950 text-white min-h-screen">
  <div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-white">Panel de Ventas</h1>
      <p class="text-slate-400 mt-1">Gestiona y revisa todas las transacciones.</p>
    </header>

    <!-- Indicador de carga principal -->
    @if (isLoading()) {
      <div class="flex justify-center items-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-lime-400"></div>
        <p class="ml-4 text-slate-300">Cargando ventas...</p>
      </div>
    }

    <!-- Tabla de ventas -->
    @if (!isLoading() && sales().length > 0) {
      <div class="bg-slate-900/50 border border-white/10 rounded-2xl overflow-x-auto">
        <table class="min-w-full leading-normal">
          <thead>
            <tr class="border-b border-slate-700 bg-slate-800/50 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">
              <th class="px-5 py-3">Detalles</th>
              <th class="px-5 py-3">Transacción</th>
              <th class="px-5 py-3">Cliente</th>
              <th class="px-5 py-3 text-center">Total</th>
              <th class="px-5 py-3 text-center">Estado</th>
              <th class="px-5 py-3">Fecha</th>
              <th class="px-5 py-3 text-center">Acciones</th>
            </tr>
          </thead>
          <tbody class="text-slate-300">
            @for (sale of sales(); track sale._id) {
              <tr class="border-b border-slate-800 hover:bg-slate-800/70">
                <td class="px-5 py-4">
                  <button (click)="toggleDetails(sale._id)" class="text-lime-400 hover:text-lime-300 font-medium text-sm">
                    {{ isDetailsVisible(sale._id) ? 'Ocultar' : 'Ver' }}
                  </button>
                </td>
                <td class="px-5 py-4 text-sm whitespace-nowrap font-mono">{{ sale.n_transaccion }}</td>
                <td class="px-5 py-4">
                  <div class="flex items-center">
                    <div class="text-sm">
                      <p class="font-medium">{{ sale.user.name }} {{ sale.user.surname }}</p>
                      <p class="text-slate-400 text-xs">{{ sale.user.email }}</p>
                    </div>
                  </div>
                </td>
                <td class="px-5 py-4 text-center font-semibold text-sm">{{ sale.total | currency:'USD' }}</td>
                <td class="px-5 py-4 text-center">
                  <span
                    [ngClass]="{
                      'bg-green-500/10 text-green-400': sale.status === 'Pagado',
                      'bg-yellow-500/10 text-yellow-400': sale.status === 'Pendiente',
                      'bg-red-500/10 text-red-400': sale.status === 'Anulado'
                    }"
                    class="py-1 px-3 rounded-full text-xs font-medium">
                    {{ sale.status }}
                  </span>
                </td>
                <td class="px-5 py-4 text-sm">{{ sale.createdAt | date:'dd/MM/yyyy HH:mm' }}</td>
                <td class="px-5 py-4 text-center">
                  @if (sale.status === 'Pendiente') {
                    <button (click)="updateStatus(sale._id, 'Pagado')" [disabled]="updatingStatusId() === sale._id"
                      class="bg-lime-500 text-slate-900 text-xs font-bold py-2 px-4 rounded-md hover:bg-lime-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-lime-500 disabled:bg-slate-600 disabled:cursor-not-allowed flex items-center justify-center">
                      @if (updatingStatusId() === sale._id) {
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                      } @else {
                        <span>Aprobar</span>
                      }
                    </button>
                  } @else {
                    <span class="text-slate-500 text-sm">-</span>
                  }
                </td>
              </tr>
              <!-- Fila de detalles (desplegable) -->
              @if (isDetailsVisible(sale._id)) {
                <tr class="bg-slate-800/50">
                  <td colspan="7" class="p-4 border-t border-slate-700">
                    <h4 class="text-md font-semibold mb-3 text-slate-300">Productos en esta venta:</h4>
                    <div class="space-y-3">
                      @for (item of sale.detail; track item.product._id) {
                        <div class="flex items-center p-3 bg-slate-900 rounded-lg border border-slate-700">
                          <img [src]="getProductImageUrl(item)" alt="{{ item.product.title }}" class="w-24 h-16 object-cover rounded-md mr-4">
                          <div class="flex-grow">
                            <p class="font-bold text-white">{{ item.product.title || 'Producto no disponible' }}</p>
                            <p class="text-sm text-slate-400">{{ item.product_type === 'course' ? 'Curso' : 'Proyecto' }}</p>
                          </div>
                          <div class="text-right">
                            <p class="font-semibold text-lime-400">{{ item.price_unit | currency:'USD' }}</p>
                          </div>
                        </div>
                      }
                    </div>
                  </td>
                </tr>
              }
            }
          </tbody>
        </table>
      </div>
    }

    <!-- Mensaje si no hay ventas -->
    @if (!isLoading() && sales().length === 0) {
      <div class="text-center py-20 bg-slate-900/50 border border-white/10 rounded-2xl">
        <svg class="mx-auto h-12 w-12 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <h3 class="mt-2 text-sm font-medium text-slate-300">No se encontraron ventas</h3>
        <p class="mt-1 text-sm text-slate-500">Aún no se ha registrado ninguna transacción.</p>
      </div>
    }
  </div>
</div>
